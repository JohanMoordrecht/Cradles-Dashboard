<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cradle & Pallet Dashboard - Final v5</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background: #f9f9f9; color: #333;}
        h1, h2 {color: #003087; text-align: center;}
        table {border-collapse: collapse; width: 100%; margin: 25px 0; background: white;}
        th, td {border: 1px solid #000; padding: 10px; text-align: center;}
        th {background-color: #003087; color: white;}
        .total {font-weight: bold; background-color: #e6f2ff;}
        .upload {background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); margin: 20px 0; text-align: center;}
        input[type="file"] {padding: 10px; font-size: 1em;}
        #status {margin-top: 10px; font-weight: bold; color: green;}
        @media print { .upload {display: none;} body {margin: 10mm; background: white;} }
    </style>
</head>
<body>

<h1>LOGISTIEK DASHBOARD – CRADLE & PALLET BEHOEFTE</h1>
<p style="text-align:center;"><strong>Laatste update:</strong> <span id="lastUpdate">originele data</span></p>

<div class="upload">
    <h2>Upload nieuwe Excel (.xls of .xlsx)</h2>
    <p>Selecteer je Logistiek-bestand – het dashboard update automatisch</p>
    <input type="file" id="excelFile" accept=".xls,.xlsx" />
    <p id="status">Oorspronkelijke data geladen</p>
</div>

<div id="dashboardContent">
    <!-- Tabellen komen hier -->
</div>

<script>
// Placeholder voor bij openen (je originele totalen)
const placeholderData = [
    {date: "18-11-2025", cradle: 199, cradleType: "110/4", pallet: 31, palletType: "170x120"},
    {date: "21-11-2025", cradle: 44, cradleType: "120/5", pallet: 6, palletType: "205x120"},
    // ... meer als je wilt, maar niet nodig – upload overschrijft alles
];

// Laad placeholder bij openen
window.onload = () => {
    renderDashboard(placeholderData);
    document.getElementById('status').innerHTML = 'Oorspronkelijke data geladen – upload een nieuwe Excel voor volledige update';
};

// Excel upload
document.getElementById('excelFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('status').innerHTML = 'Bezig met lezen van ' + file.name + '...';

    const reader = new FileReader();
    reader.onload = function(ev) {
        try {
            const data = ev.target.result;
            const workbook = XLSX.read(data, {type: 'binary'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});

            const processed = [];
            let started = false;
            for (const row of rows) {
                const orderCell = String(row[0] || '').trim();
                if (orderCell.includes('Ordernummer')) {
                    started = true;
                    continue;
                }
                if (!started || row.length < 9 || orderCell === '') continue;

                const cradleStr = String(row[5] || '0').replace(/[\.,]/g, '');
                const palletStr = String(row[7] || '0').replace(/[\.,]/g, '');

                processed.push({
                    date: String(row[1] || '').trim(),
                    cradle: parseInt(cradleStr) || 0,
                    cradleType: String(row[6] || 'Overig').trim(),
                    pallet: parseInt(palletStr) || 0,
                    palletType: String(row[8] || '').trim()
                });
            }

            if (processed.length === 0) throw "Geen orders gevonden in het bestand";

            renderDashboard(processed);
            document.getElementById('status').innerHTML = `Succes! ${processed.length} orders geladen uit ${file.name}`;
            document.getElementById('lastUpdate').innerText = new Date().toLocaleDateString('nl-NL');
        } catch (err) {
            document.getElementById('status').innerHTML = '<span style="color:red;">Fout: ' + err + ' – probeer een ander bestand of .xlsx</span>';
        }
    };
    reader.readAsBinaryString(file);
});

// Volledige render functie (nu 100% correct)
function renderDashboard(data) {
    if (data.length === 0) {
        document.getElementById('dashboardContent').innerHTML = '<p style="text-align:center; color:red;">Geen data beschikbaar.</p>';
        return;
    }

    const weekMap = {};
    data.forEach(row => {
        if (!row.date) return;
        const parts = row.date.split('-');
        if (parts.length !== 3) return;
        const [d, m, y] = parts.map(n => parseInt(n));
        const date = new Date(y, m - 1, d);
        if (isNaN(date.getTime())) return;
        const weekNum = getWeekNumber(date);
        const yearWeek = `\( {y}-W \){String(weekNum).padStart(2, '0')}`;
        if (!weekMap[yearWeek]) weekMap[yearWeek] = {cradles: {}, pallets: {}};
        weekMap[yearWeek].cradles[row.cradleType] = (weekMap[yearWeek].cradles[row.cradleType] || 0) + row.cradle;
        weekMap[yearWeek].pallets[row.palletType] = (weekMap[yearWeek].pallets[row.palletType] || 0) + row.pallet;
    });

    const sortedWeeks = Object.keys(weekMap).sort();

    const cradleTypes = [...new Set(data.map(r => r.cradleType).filter(Boolean))].sort();
    const palletTypes = [...new Set(data.map(r => r.palletType).filter(Boolean))].sort((a, b) => {
        const area = t => t.split('x').reduce((p, c) => p * parseInt(c || 0), 1);
        return area(b) - area(a);
    });

    const totalCradles = data.reduce((s, r) => s + r.cradle, 0);
    const totalPallets = data.reduce((s, r) => s + r.pallet, 0);

    let html = `<p style="text-align:center; font-size:1.3em;">
        Totale cradlebehoefte: <strong>${totalCradles.toLocaleString('nl')}</strong> • 
        Totale palletbehoefte: <strong>${totalPallets.toLocaleString('nl')}</strong>
    </p>`;

    // Cradle tabel
    html += `<h2>Cradlebehoefte per week – per type</h2><table><tr><th>Type</th>`;
    sortedWeeks.forEach(w => html += `<th>${w.replace('-W', ' week ')}</th>`);
    html += `<th>TOTAAL</th></tr>`;

    cradleTypes.forEach(type => {
        html += `<tr><td><strong>${type}</strong></td>`;
        let rowTotal = 0;
        sortedWeeks.forEach(w => {
            const val = weekMap[w].cradles[type] || 0;
            html += `<td>${val}</td>`;
            rowTotal += val;
        });
        html += `<td class="total">${rowTotal}</td></tr>`;
    });

    html += `<tr class="total"><td><strong>Totaal per week</strong></td>`;
    sortedWeeks.forEach(w => {
        const sum = Object.values(weekMap[w].cradles).reduce((a, b) => a + b, 0);
        html += `<td><strong>${sum}</strong></td>`;
    });
    html += `<td><strong>${totalCradles}</strong></td></tr></table>`;

    // Pallet tabel
    html += `<h2>Palletbehoefte per week – per type</h2><table><tr><th>Type</th>`;
    sortedWeeks.forEach(w => html += `<th>${w.replace('-W', ' week ')}</th>`);
    html += `<th>TOTAAL</th></tr>`;

    palletTypes.forEach(type => {
        html += `<tr><td><strong>${type}</strong></td>`;
        let rowTotal = 0;
        sortedWeeks.forEach(w => {
            const val = weekMap[w].pallets[type] || 0;
            html += `<td>${val}</td>`;
            rowTotal += val;
        });
        html += `<td class="total">${rowTotal}</td></tr>`;
    });

    html += `<tr class="total"><td><strong>Totaal per week</strong></td>`;
    sortedWeeks.forEach(w => {
        const sum = Object.values(weekMap[w].pallets).reduce((a, b) => a + b, 0);
        html += `<td><strong>${sum}</strong></td>`;
    });
    html += `<td><strong>${totalPallets}</strong></td></tr></table>`;

    document.getElementById('dashboardContent').innerHTML = html;
}

// Correcte ISO week functie
function getWeekNumber(d) {
    const date = new Date(d);
    date.setHours(0, 0, 0, 0);
    date.setDate(date.getDate() + 4 - (date.getDay() || 7));
    const yearStart = new Date(date.getFullYear(), 0, 1);
    return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
}
</script>

</body>
</html>