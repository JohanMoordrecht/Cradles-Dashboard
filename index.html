<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pallet & Cradle Behoefte - Volledig Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; color: #333; }
    h1, h2 { text-align: center; color: #2c3e50; }
    .container { max-width: 1500px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .upload-area { border: 3px dashed #3498db; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 30px; background: #ecf0f1; }
    .upload-area:hover { background: #d6e6f5; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: auto; }
    th { background: #3498db; color: white; padding: 12px; cursor: pointer; white-space: nowrap; }
    th:hover { background: #2980b9; }
    td { padding: 10px 12px; border-bottom: 1px solid #ddd; text-align: center; }
    td.left { text-align: left; }
    tr:nth-child(even) { background: #f9f9f9; }
    .total-row { font-weight: bold; background: #2c3e50 !important; color: white; font-size: 1.1em; }
    .summary-table th { background: #27ae60; }
    .info { text-align: center; color: #7f8c8d; margin: 20px 0; font-size: 1.1em; }
    .error { color: #e74c3c; font-weight: bold; text-align: center; }
    .section { margin-top: 60px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pallet & Cradle Behoefte - Volledig Dashboard</h1>

    <div class="upload-area">
      <p><strong>Upload je Excel-bestand (.xls of .xlsx)</strong></p>
      <p>Bijv: Logistiek - Pallet behoefte.xls</p>
      <input type="file" id="fileInput" accept=".xls,.xlsx" />
    </div>

    <div id="output"></div>
  </div>

  <script>
    // Sorteerfunctie voor tabellen
    function sortTable(table, colIndex, asc = true) {
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        let aText = a.cells[colIndex].innerText.trim();
        let bText = b.cells[colIndex].innerText.trim();
        if (!isNaN(aText) && !isNaN(bText) && aText !== '' && bText !== '') {
          return asc ? Number(aText) - Number(bText) : Number(bText) - Number(aText);
        }
        return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

          // Exacte kolomnamen zoals in jouw bestand
          const requiredCols = [
            "Ordernummer",
            "Afleverdatum", 
            "Artikel",
            "Artikelomschrijving",
            "Aantal",
            "Cradle behoefte",
            "Cradle Type",
            "Pallet behoefte",
            "Pallet Type"
          ];

          // Zoek de header rij
          let headerRow = -1;
          for (let i = 0; i < json.length; i++) {
            const row = json[i].map(cell => (cell || "").toString().trim());
            if (requiredCols.every(col => row.includes(col))) {
              headerRow = i;
              break;
            }
          }

          if (headerRow === -1) throw new Error("Kolomnamen niet gevonden. Zorg dat alle kolommen exact aanwezig zijn.");

          const headers = json[headerRow].map(h => (h || "").toString().trim());

          // Maak mapping van kolomnaam naar index
          const colIndices = {};
          requiredCols.forEach(col => {
            const idx = headers.indexOf(col);
            if (idx === -1) throw new Error(`Kolom "${col}" niet gevonden.`);
            colIndices[col] = idx;
          });

          // Verzamel data rijen (skip lege en subtotaalrijen)
          const rows = [];
          for (let i = headerRow + 1; i < json.length; i++) {
            const rawRow = json[i];
            if (!rawRow || rawRow.length < 5) continue;

            const ordernummer = (rawRow[colIndices["Ordernummer"]] || "").toString().trim();
            const palletType = (rawRow[colIndices["Pallet Type"]] || "").toString().trim();

            // Skip subtotaalrijen (geen ordernummer en geen pallet type, of met totalen)
            if ((ordernummer === "" || ordernummer === "0") && (palletType === "" || palletType.includes("TOTAAL"))) continue;

            rows.push({
              ordernummer: ordernummer,
              afleverdatum: rawRow[colIndices["Afleverdatum"]] || "",
              artikel: rawRow[colIndices["Artikel"]] || "",
              omschrijving: rawRow[colIndices["Artikelomschrijving"]] || "",
              aantal: rawRow[colIndices["Aantal"]] || "",
              cradle: parseInt(rawRow[colIndices["Cradle behoefte"]] || 0) || 0,
              cradleType: rawRow[colIndices["Cradle Type"]] || "",
              pallet: parseInt(rawRow[colIndices["Pallet behoefte"]] || 0) || 0,
              palletType: palletType
            });
          }

          // Groeperen voor samenvatting
          const grouped = {};
          const ordersPerType = {};
          rows.forEach(r => {
            const pt = r.palletType || "Onbekend";
            if (!grouped[pt]) {
              grouped[pt] = { cradles: 0, pallets: 0 };
              ordersPerType[pt] = new Set();
            }
            grouped[pt].cradles += r.cradle;
            grouped[pt].pallets += r.pallet;
            if (r.ordernummer) ordersPerType[pt].add(r.ordernummer);
          });

          const sortedTypes = Object.keys(grouped).sort();

          // Bouw HTML
          let html = `
            <div class="info">
              Bestand: <strong>${file.name}</strong> • Verwerkt op: ${new Date().toLocaleString('nl-NL')} • ${rows.length} regels verwerkt
            </div>

            <h2>Samenvatting per Palletmaat</h2>
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Pallet Type</th>
                  <th>Aantal Orders</th>
                  <th>Totale Cradles</th>
                  <th>Totale Pallets</th>
                </tr>
              </thead>
              <tbody>`;

          let totalOrders = 0, totalCradles = 0, totalPallets = 0;
          sortedTypes.forEach(type => {
            const countOrders = ordersPerType[type]?.size || 0;
            const cradles = grouped[type].cradles;
            const pallets = grouped[type].pallets;
            totalOrders += countOrders;
            totalCradles += cradles;
            totalPallets += pallets;

            html += `<tr>
              <td><strong>${type}</strong></td>
              <td>${countOrders}</td>
              <td>${cradles}</td>
              <td>${pallets}</td>
            </tr>`;
          });

          html += `<tr class="total-row">
              <td>TOTAAL</td>
              <td>${totalOrders}</td>
              <td>${totalCradles}</td>
              <td>${totalPallets}</td>
            </tr></tbody></table>

            <div class="section">
              <h2>Volledige details (alle orders)</h2>
              <table id="detailTable">
                <thead>
                  <tr>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 0)">Ordernummer</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 1)">Afleverdatum</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 2)">Artikel</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 3)">Artikelomschrijving</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 4)">Aantal</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 5)">Cradle behoefte</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 6)">Cradle Type</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 7)">Pallet behoefte</th>
                    <th onclick="sortTable(this.parentNode.parentNode.parentNode, 8)">Pallet Type</th>
                  </tr>
                </thead>
                <tbody>`;

          rows.forEach(r => {
            html += `<tr>
              <td>${r.ordernummer}</td>
              <td>${r.afleverdatum}</td>
              <td>${r.artikel}</td>
              <td class="left">${r.omschrijving}</td>
              <td>${r.aantal}</td>
              <td>${r.cradle}</td>
              <td>${r.cradleType}</td>
              <td>${r.pallet}</td>
              <td><strong>${r.palletType}</strong></td>
            </tr>`;
          });

          html += `</tbody></table></div>`;

          document.getElementById('output').innerHTML = html;

        } catch (err) {
          document.getElementById('output').innerHTML = `<p class="error">Fout: ${err.message}</p>`;
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
